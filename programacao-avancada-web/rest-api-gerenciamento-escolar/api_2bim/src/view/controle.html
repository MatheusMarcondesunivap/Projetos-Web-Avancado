<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <title>CRUD Usuários com ApiService</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Meta tag para responsividade em dispositivos móveis -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Bootstrap para estilização rápida e responsiva -->
  <style>
    body {
      padding: 2em;
    }

    table {
      margin-top: 1em;
    }
  </style>
</head>

<body class="container">

  <h1 class="mb-4">Gerenciamento de alunos</h1>
  <div class="mb-3">
    <input type="number" id="txtId" class="form-control mb-2" placeholder="Matrícula" />
    <input type="text" id="txtNome" class="form-control mb-2" placeholder="Nome" />
    <select id="txtCargo" class="form-control mb-2">
      <option value="">Selecione o cargo</option>
      <option value="admin">Admin</option>
      <option value="aluno">Aluno</option>
    </select>
    <input type="date" id="txtData" class="form-control mb-2" placeholder="Data de nascimento" />
    <input type="text" id="txtSenha" class="form-control mb-2" placeholder="Senha" />
  </div>

  <!-- Div onde os botões CRUD serão criados dinamicamente -->
  <div class="mb-3" id="divBotoes"></div>
  <!-- Div para mensagens de resposta/erro -->
  <div id="divResposta"></div>
  <!-- Div onde a tabela de usuários será renderizada -->
  <div id="divTabela"></div>

  <script type="module">
    // Importa a classe ApiService para comunicação com a API (abstrai fetch/axios)
    import ApiService from './ApiService.js';

    const userData = JSON.parse(localStorage.getItem("userData"));

    // Pega o token dentro da resposta
    const token = userData?.data?.token;

    console.log("Token recuperado:", token);
    let role = null;
    let payload = null;

    if (token) {
      payload = JSON.parse(atob(token.split(".")[1])); // decodifica o meio do JWT
      console.log("Payload do token:", payload);

      role = payload.public?.Role;

      console.log("Role do usuário:", role);
    }

    const api = new ApiService(token);


    // Variável global que armazenará os dados da API para manipulação local
    let API_DATA;

    // Referências para elementos do formulário e divs
    const txtId = document.getElementById("txtId");
    const txtNome = document.getElementById("txtNome");
    const txtCargo = document.getElementById("txtCargo");
    const txtData = document.getElementById("txtData");
    const txtSenha = document.getElementById("txtSenha");
    const divBotoes = document.getElementById("divBotoes");
    const divResposta = document.getElementById("divResposta");


    function createButton(text, className) {
      const btn = document.createElement("button");
      btn.textContent = text;
      btn.className = `btn ${className} me-2 mb-2`; // Margem para espaçamento
      return btn;
    }

    const btnListar = createButton("Listar", "btn-primary");
    btnListar.onclick = async function btnListar_click() {
      // Chama a função que carrega e exibe todos usuários
      listAll();
    };
    divBotoes.appendChild(btnListar);

    const btnProcurar = createButton("Procurar", "btn-info");
    btnProcurar.onclick = async function btnProcurar_click() {
      const id = txtId.value.trim();
      if (!id) return alert("Informe a matrícula."); // ID obrigatório para procurar
      
      listOne(id);
    };

    divBotoes.appendChild(btnProcurar);

    const btnCriar = createButton("Criar", "btn-success");
    btnCriar.onclick = async function btnCriar_click() {
      if (txtNome.value.trim() == "") {
        divResposta.textContent = "Nome inválido";
        divResposta.className = "alert alert-danger";
        return;
      }
      else if (txtCargo.value.trim() == "") {
        divResposta.textContent = "Cargo inválido";
        divResposta.className = "alert alert-danger";
        return;
      }
      // Monta o objeto a ser enviado na requisição POST
      const obj = {
        controle: {
          Matricula: txtId.value.trim(),
          Nome: txtNome.value.trim(),
          Cargo: txtCargo.value.trim(),
          dataNascimento: txtData.value.trim()
        }
      };

      await api.post("http://localhost:8080/auth/register", obj);
      // Atualiza a lista após criar
      listAll();
    };
    divBotoes.appendChild(btnCriar);

    // Botão Atualizar: modifica usuário existente pelo ID informado
    const btnAtualizar = createButton("Atualizar", "btn-warning");
    btnAtualizar.onclick = async function btnAtualizar_click() {
      const id = txtId.value.trim();
      if (!id) return alert("Informe o ID."); // ID obrigatório para atualizar
      if (id != payload.private?.matricula && txtSenha.value.trim() !== ""){
        alert("Somente é possível alterar a senha do próprio usuário.");
      } else {
        const obj = { controle: {} };
        if (txtNome.value.trim()) obj.controle.Nome = txtNome.value.trim();
        if (txtCargo.value.trim()) obj.controle.Cargo = txtCargo.value.trim();
        if (txtData.value.trim()) obj.controle.dataNascimento = txtData.value.trim();
        if (txtSenha.value.trim()) obj.controle.Senha = txtSenha.value.trim();
        obj.controle.Matricula = id; 
        // Chama API para atualizar usuário pelo ID
        await api.put("http://localhost:8080/usuarios", id, obj);
      }
      
      
      if (role === "aluno"){
        listOne(payload.private?.matricula);
      } else {
        listAll();
      }
    };
    divBotoes.appendChild(btnAtualizar);

    // Botão Excluir: remove usuário pelo ID informado
    const btnExcluir = createButton("Excluir", "btn-danger");
    btnExcluir.onclick = async function btnExcluir_click() {
      const id = txtId.value.trim();
      if (!id) return alert("Informe a matrícula."); // ID obrigatório para exclusão
      await api.delete("http://localhost:8080/usuarios", id);
      // Atualiza a lista após exclusão
      listAll();
    };
    divBotoes.appendChild(btnExcluir);

    async function listAll() {
      API_DATA = await api.get("http://localhost:8080/usuarios"); // Busca todos os usuários via GET
      renderTable(API_DATA); // Renderiza tabela com os dados retornados
    }

    async function listOne(id){
      API_DATA = await api.getById(`http://localhost:8080/usuarios`, id);
      renderTable(API_DATA); // Renderiza tabela com os dados retornados
    }


    function renderTable(dados) {
      const divTabela = document.getElementById("divTabela");
      divTabela.innerHTML = "";
      const table = document.createElement("table");
      table.className = "table table-bordered table-striped";

      // Cria cabeçalho da tabela
      const thead = document.createElement("thead");
      thead.className = "table-light";
      const trHead = document.createElement("tr");

      // Cabeçalhos básicos
      ["Matrícula", "Nome", "Cargo", "Data de Nascimento", "Senha"].forEach(text => {
        const th = document.createElement("th");
        th.textContent = text;
        trHead.appendChild(th);
      });

      // Adiciona "Ações" somente se for admin
      if (role === "admin") {
        const thAcoes = document.createElement("th");
        thAcoes.textContent = "Ações";
        trHead.appendChild(thAcoes);
      }

      thead.appendChild(trHead);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      //alert(dados.success);
      // Para cada usuário, cria uma linha na tabela
      let cadastros = dados.data.cadastros;
      if (!Array.isArray(cadastros)) {
        cadastros = [cadastros];
      }
      cadastros.forEach(item => {
        const tr = document.createElement("tr");

        // Coluna ID
        const tdId = document.createElement("td");
        tdId.textContent = item.matricula;
        tr.appendChild(tdId);

        // Coluna nome aluno
        const tdNome = document.createElement("td");
        tdNome.textContent = item.nome;
        tr.appendChild(tdNome);

        // Coluna data de nascimento
        const tdCargo = document.createElement("td");
        tdCargo.textContent = item.cargo;
        tr.appendChild(tdCargo);

        // Coluna data de nascimento
        const tdDataNascimento = document.createElement("td");
        tdDataNascimento.textContent = item.dataNascimento;
        tr.appendChild(tdDataNascimento);

        // Coluna turma
        const tdSenha = document.createElement("td");
        tdSenha.textContent = item.senha;
        tr.appendChild(tdSenha);

        // Coluna Ações só para admin
        if (role === "admin") {
          // Coluna Ações: botões Selecionar e Excluir
          const tdAcoes = document.createElement("td");

          // Botão Selecionar: preenche o formulário com os dados do usuário clicado
          const btnSel = createButton("Selecionar", "btn-sm btn-info me-1");
          const itemSelecionado = item;
          btnSel.onclick = function () {
            // Busca o item na lista global pelo ID

            if (itemSelecionado) {
              txtId.value = itemSelecionado.matricula;    
              txtNome.value = itemSelecionado.nome;   
              txtCargo.value = itemSelecionado.cargo;
              txtData.value = itemSelecionado.dataNascimento; 
              divResposta.textContent = "";            // Limpa mensagens anteriores
              divResposta.className = "";
            }
          };
          tdAcoes.appendChild(btnSel);

          // Botão Excluir: pergunta confirmação e exclui o usuário da API
          const btnExc = createButton("Excluir", "btn-sm btn-danger");
          btnExc.onclick = async function () {
            if (confirm(`Confirma excluir o usuário com matricula ${item.matricula}?`)) {
              await api.delete("http://localhost:8080/usuarios", item.matricula); // Exclui pela API
              listAll();                          // Atualiza lista após exclusão
              divResposta.textContent = `Usuário com matricula ${item.matricula} excluído com sucesso.`;
              divResposta.className = "alert alert-success";
            }
          };
          tdAcoes.appendChild(btnExc);

          tr.appendChild(tdAcoes);
        }

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      divTabela.appendChild(table);
    }

    if (role === "aluno"){
      txtData.style.display = "none";
      txtNome.style.display = "none";
      txtCargo.style.display = "none";
      btnCriar.style.display = "none";
      btnExcluir.style.display = "none";
      btnListar.style.display = "none";
      btnProcurar.style.display = "none";
      listOne(payload.private?.matricula);
    }

    if (role == "admin"){
      // Inicializa a listagem ao carregar a página
      listAll();
    }

  </script>

  
</body>

</html>